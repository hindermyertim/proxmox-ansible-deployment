---
- name: Configure agents on deployed systems
  hosts: agents
  become: true
  vars:
    install_monitoring: true
    install_qemu_agent: true
    install_newt: true
    install_wazuh: true
    install_checkmk: true
    install_base_tools: true
    install_docker: false       # Install Docker and Docker Compose (default: false)
    
    # Newt (Pangolin) configuration
    newt_server: "{{ lookup('env', 'NEWT_SERVER') }}"
    newt_token: "{{ lookup('env', 'NEWT_TOKEN') }}"
    newt_accept_clients: "{{ lookup('env', 'NEWT_ACCEPT_CLIENTS') | default('false') }}"
    
    # Wazuh configuration
    wazuh_manager_ip: "{{ lookup('env', 'WAZUH_MANAGER_IP') }}"
    wazuh_agent_name: "{{ ansible_hostname }}"
    
    # CheckMK configuration
    checkmk_server: "{{ lookup('env', 'CHECKMK_SERVER') }}"
    checkmk_site: "{{ lookup('env', 'CHECKMK_SITE') | default('main') }}"
    checkmk_agent_port: 6556
    
  tasks:
    # ===========================================================================
    # SYSTEM UPDATES
    # ===========================================================================
    - name: Update package cache (Debian/Ubuntu)
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    # ===========================================================================
    # BASE TOOLS (neovim, git, curl, etc.)
    # ===========================================================================
    - name: Install base tools
      apt:
        name:
          - neovim
          - git
          - curl
          - wget
          - htop
          - net-tools
          - vim-tiny
        state: present
      when: 
        - install_base_tools | bool
        - ansible_os_family == "Debian"

    - name: Set neovim as default editor
      alternatives:
        name: editor
        path: /usr/bin/nvim
      when: 
        - install_base_tools | bool
        - ansible_os_family == "Debian"

    # ===========================================================================
    # DOCKER & DOCKER COMPOSE (optional)
    # ===========================================================================
    - name: Install Docker and Docker Compose
      block:
        - name: Install Docker prerequisites
          apt:
            name:
              - ca-certificates
              - curl
              - gnupg
              - lsb-release
            state: present

        - name: Add Docker GPG key
          apt_key:
            url: https://download.docker.com/linux/debian/gpg
            state: present

        - name: Add Docker repository
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
            state: present
            filename: docker

        - name: Install Docker
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: yes

        - name: Start and enable Docker
          systemd:
            name: docker
            state: started
            enabled: yes

        - name: Add root to docker group
          user:
            name: root
            groups: docker
            append: yes

        - name: Verify Docker installation
          command: docker --version
          register: docker_version
          changed_when: false

        - name: Verify Docker Compose installation
          command: docker compose version
          register: docker_compose_version
          changed_when: false

        - name: Display Docker versions
          debug:
            msg: |
              Docker installed: {{ docker_version.stdout }}
              Docker Compose installed: {{ docker_compose_version.stdout }}
      when: 
        - install_docker | bool
        - ansible_os_family == "Debian"

    # ===========================================================================
    # QEMU GUEST AGENT (for Proxmox VMs)
    # ===========================================================================
    - name: Install QEMU guest agent
      package:
        name: qemu-guest-agent
        state: present
      when: 
        - install_qemu_agent | bool
        - ansible_virtualization_type == "kvm"

    - name: Start and enable QEMU guest agent
      service:
        name: qemu-guest-agent
        state: started
        enabled: yes
      when: 
        - ansible_virtualization_role != "host"
        - install_qemu_agent | bool
        - ansible_virtualization_type == "kvm"

    # ===========================================================================
    # NODE EXPORTER (Prometheus metrics)
    # ===========================================================================
    - name: Install Node Exporter
      block:
        - name: Create node_exporter user
          user:
            name: node_exporter
            system: yes
            shell: /bin/false
            create_home: no

        - name: Download node_exporter
          get_url:
            url: https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
            dest: /tmp/node_exporter.tar.gz

        - name: Extract node_exporter
          unarchive:
            src: /tmp/node_exporter.tar.gz
            dest: /tmp/
            remote_src: yes

        - name: Copy node_exporter binary
          copy:
            src: /tmp/node_exporter-1.7.0.linux-amd64/node_exporter
            dest: /usr/local/bin/node_exporter
            mode: '0755'
            owner: node_exporter
            group: node_exporter
            remote_src: yes

        - name: Create node_exporter service
          copy:
            dest: /etc/systemd/system/node_exporter.service
            content: |
              [Unit]
              Description=Node Exporter
              After=network.target

              [Service]
              Type=simple
              User=node_exporter
              Group=node_exporter
              ExecStart=/usr/local/bin/node_exporter
              Restart=on-failure

              [Install]
              WantedBy=multi-user.target

        - name: Start and enable node_exporter
          systemd:
            name: node_exporter
            state: started
            enabled: yes
            daemon_reload: yes
      when: install_monitoring | bool

    # ===========================================================================
    # NEWT (Pangolin Reverse Proxy Client)
    # ===========================================================================
    - name: Install Newt agent for Pangolin
      block:
        - name: Download Newt agent
          get_url:
            url: https://github.com/fosrl/newt/releases/latest/download/newt_linux_amd64
            dest: /usr/local/bin/newt
            mode: '0755'

        - name: Create newt config directory
          file:
            path: /etc/newt
            state: directory
            mode: '0755'

        - name: Configure Newt agent
          copy:
            dest: /etc/newt/config.yml
            content: |
              endpoint: "{{ newt_endpoint }}"
              id: "{{ newt_id }}"
              secret: "{{ newt_secret }}"

          when:
            - newt_endpoint is defined and newt_endpoint != ""
            - newt_id is defined and newt_id != ""
            - newt_secret is defined and newt_secret != ""
        - name: Create newt systemd service (without --accept-clients)
          copy:
            dest: /etc/systemd/system/newt.service
            content: |
              [Unit]
              Description=Newt Agent for Pangolin
              After=network.target

              [Service]
              Type=simple
              ExecStart=/usr/local/bin/newt start --config /etc/newt/config.yml
              Restart=always
              RestartSec=10

              [Install]
              WantedBy=multi-user.target
          when: 
            - newt_accept_clients | lower != 'true'
            - newt_accept_clients | lower != 'yes'
            - newt_accept_clients != '1'

        - name: Create newt systemd service (with --accept-clients for Olm)
          copy:
            dest: /etc/systemd/system/newt.service
            content: |
              [Unit]
              Description=Newt Agent for Pangolin (Olm Client Mode)
              After=network.target

              [Service]
              Type=simple
              ExecStart=/usr/local/bin/newt start --config /etc/newt/config.yml --accept-clients
              Restart=always
              RestartSec=10

              [Install]
              WantedBy=multi-user.target
          when: 
            - newt_accept_clients | lower == 'true' or
              newt_accept_clients | lower == 'yes' or
              newt_accept_clients == '1'

        - name: Start and enable newt service
          systemd:
            name: newt
            state: started
            enabled: yes
            daemon_reload: yes
          when:
            - newt_endpoint is defined and newt_endpoint != ""
            - newt_id is defined and newt_id != ""
            - newt_secret is defined and newt_secret != ""
      when: install_newt | bool

    # ===========================================================================
    # WAZUH AGENT (Security monitoring)
    # ===========================================================================
    - name: Install Wazuh Agent
      block:
        - name: Install dependencies
          apt:
            name:
              - curl
              - apt-transport-https
              - lsb-release
              - gnupg
            state: present

        - name: Add Wazuh GPG key
          shell: |
            curl -fsSL https://packages.wazuh.com/key/GPG-KEY-WAZUH | gpg --dearmor -o /usr/share/keyrings/wazuh-archive-keyring.gpg
          args:
            creates: /usr/share/keyrings/wazuh-archive-keyring.gpg

        - name: Add Wazuh repository
          apt_repository:
            repo: "deb [signed-by=/usr/share/keyrings/wazuh-archive-keyring.gpg] https://packages.wazuh.com/4.x/apt/ stable main"
            state: present
            filename: wazuh

        - name: Install Wazuh agent
          apt:
            name: wazuh-agent
            state: present
            update_cache: yes
          environment:
            WAZUH_MANAGER: "{{ wazuh_manager_ip }}"
            WAZUH_AGENT_NAME: "{{ wazuh_agent_name }}"

        - name: Start and enable Wazuh agent
          systemd:
            name: wazuh-agent
            state: started
            enabled: yes
            daemon_reload: yes
      when: 
        - install_wazuh | bool
        - wazuh_manager_ip != ""

    # ===========================================================================
    # CHECKMK AGENT (Analytics/Monitoring)
    # ===========================================================================
    - name: Install CheckMK Agent
      block:
        - name: Install xinetd (required for CheckMK)
          apt:
            name: xinetd
            state: present

        - name: Download CheckMK agent
          get_url:
            url: "http://{{ checkmk_server }}/{{ checkmk_site }}/check_mk/agents/check-mk-agent_all.deb"
            dest: /tmp/check-mk-agent.deb
          when: checkmk_server != ""

        - name: Install CheckMK agent
          shell: |
            dpkg --force-bad-verify -i /tmp/check-mk-agent.deb || apt-get install -f -y
          args:
            creates: /usr/bin/check_mk_agent

        - name: Configure CheckMK xinetd service
          copy:
            dest: /etc/xinetd.d/check-mk-agent
            content: |
              service check-mk-agent
              {
                  type           = UNLISTED
                  port           = {{ checkmk_agent_port }}
                  socket_type    = stream
                  protocol       = tcp
                  wait           = no
                  user           = root
                  server         = /usr/bin/check_mk_agent
                  disable        = no
              }

        - name: Restart xinetd
          systemd:
            name: xinetd
            state: restarted
            enabled: yes
      when: 
        - install_checkmk | bool
        - checkmk_server != ""

    # ===========================================================================
    # VERIFICATION
    # ===========================================================================
    - name: Display installed software
      debug:
        msg: |
          Installed on {{ inventory_hostname }}:
          
          Base Tools:
          - Neovim: {{ 'Yes' if install_base_tools else 'No' }}
          - Git, curl, wget, htop: {{ 'Yes' if install_base_tools else 'No' }}
          - Docker: {{ 'Yes' if install_docker else 'No' }}
          
          Agents:
          - QEMU Guest Agent: {{ 'Yes' if install_qemu_agent else 'No' }}
          - Node Exporter: {{ 'Yes' if install_monitoring else 'No' }}
          - Newt (Pangolin): {{ 'Yes' if install_newt else 'No' }}{% if newt_accept_clients | lower in ['true', 'yes', '1'] %} [Olm mode]{% endif %}

          - Wazuh: {{ 'Yes' if install_wazuh else 'No' }}
          - CheckMK: {{ 'Yes' if install_checkmk else 'No' }}
