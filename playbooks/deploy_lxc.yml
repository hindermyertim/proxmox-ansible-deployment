---
- name: Deploy LXC Containers to Proxmox
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../group_vars/all.yml
  vars:
    proxmox_api_host: "{{ lookup('env', 'PROXMOX_HOST') }}"
    proxmox_api_user: "{{ lookup('env', 'PROXMOX_USER') }}"
    proxmox_api_password: "{{ lookup('env', 'PROXMOX_PASSWORD') }}"
    
  tasks:
    - name: Create LXC container
      community.general.proxmox:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        hostname: "{{ item.hostname }}"
        ostemplate: "{{ item.template }}"
        cores: "{{ item.cores | default(2) }}"
        memory: "{{ item.memory | default(1024) }}"
        swap: "{{ item.swap | default(512) }}"
        disk: "{{ item.storage | default('local-lvm') }}:{{ item.disk_size | default(8) }}"
        netif: "{{ item.netif | default({'net0': 'name=eth0,bridge=vmbr0,ip=dhcp'}) }}"
        password: "{{ item.password | default('changeme') }}"
        unprivileged: "{{ item.unprivileged | default(true) }}"
        features:
          - nesting={{ item.nesting | default(1) }}
        state: present
      loop: "{{ containers }}"
      register: lxc_results

    - name: Start containers
      community.general.proxmox:
        api_host: "{{ proxmox_api_host }}"
        api_user: "{{ proxmox_api_user }}"
        api_password: "{{ proxmox_api_password }}"
        node: "{{ proxmox_node }}"
        vmid: "{{ item.vmid }}"
        state: started
      loop: "{{ containers }}"

    - name: Wait for containers to be accessible
      ansible.builtin.wait_for:
        host: "{{ item.ip }}"
        port: 22
        timeout: 300
      loop: "{{ containers }}"
      when: item.ip is defined

    - name: Configure console autologin
      ansible.builtin.shell: |
        ssh root@{{ item.ip }} "mkdir -p /etc/systemd/system/console-getty.service.d && cat > /etc/systemd/system/container-getty@1.service.d/override.conf << 'EOFINNER'
        [Service]
        ExecStart=
        ExecStart=-/sbin/agetty --autologin root --noclear --keep-baud console 115200,38400,9600 \$TERM
        EOFINNER
        systemctl daemon-reload && systemctl restart container-getty@1"
      loop: "{{ containers }}"
      when: item.ip is defined

    - name: Copy SSH keys to containers
      shell: |
        ssh root@{{ proxmox_api_host }} "cat ~/.ssh/id_ed25519.pub | pct exec {{ item.vmid }} -- bash -c 'mkdir -p /root/.ssh && cat >> /root/.ssh/authorized_keys && chmod 700 /root/.ssh && chmod 600 /root/.ssh/authorized_keys'"
      loop: "{{ containers }}"

    - name: Copy local SSH keys to containers
      shell: |
        cat ~/.ssh/id_ed25519.pub | ssh root@{{ proxmox_api_host }} "pct exec {{ item.vmid }} -- bash -c 'cat >> /root/.ssh/authorized_keys'"
      loop: "{{ containers }}"
    - name: Enable console autologin (LXC)
      shell: ssh root@{{ proxmox_api_host }} "pct exec {{ item.vmid }} -- bash -c 'mkdir -p /etc/systemd/system/console-getty.service.d && /bin/echo -e "[Service]\nExecStart=\nExecStart=-/sbin/agetty --autologin root --noclear --keep-baud console 115200,38400,9600 \\$TERM" > /etc/systemd/system/container-getty@1.service.d/override.conf && systemctl daemon-reload && systemctl restart container-getty@1'"
      loop: "{{ containers }}"

    - name: Wait for containers to get IP addresses
      pause:
        seconds: 10

    - name: Get container IP addresses
      shell: |
        ssh root@{{ proxmox_api_host }} "pct exec {{ item.vmid }} -- ip -4 addr show eth0 | grep inet | awk '{print \$2}' | cut -d/ -f1"
      register: container_ips
      loop: "{{ containers }}"
      when: item.netif.net0 is defined

    - name: Update inventory with deployed containers
      blockinfile:
        path: "{{ playbook_dir }}/../inventory/hosts.yml"
        marker: "        # {mark} ANSIBLE MANAGED - LXC CONTAINERS"
        insertafter: "      hosts:"
        block: |
          {% for idx in range(containers | length) %}
          {% if container_ips.results[idx].stdout is defined %}
                  {{ containers[idx].hostname }}:
                    ansible_host: {{ container_ips.results[idx].stdout }}
                    ansible_user: root
          {% endif %}
          {% endfor %}
      when: container_ips.results | length > 0
