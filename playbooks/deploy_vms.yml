---
- name: Deploy VMs to Proxmox with Cloud-Init
  hosts: localhost
  gather_facts: false
  become: false
  vars:
    proxmox_api_host: "{{ lookup('env', 'PROXMOX_HOST') }}"
    proxmox_api_user: "{{ lookup('env', 'PROXMOX_USER') }}"
    proxmox_api_password: "{{ lookup('env', 'PROXMOX_PASSWORD') }}"
    proxmox_node: "pve"
    vm_name_input: "{{ vm_name | default('debian-vm-01') }}"
    vm_id_input: "{{ vm_id | default(101) }}"
    vm_cores_input: "{{ vm_cores | default(2) }}"
    vm_memory_input: "{{ vm_memory | default(2048) }}"
    vm_disk_input: "{{ vm_disk | default(32) }}"
    vm_storage_input: "{{ vm_storage | default('local-lvm') }}"
    vm_ip_input: "{{ vm_ip | default('' ) }}"
    vm_gateway_input: "{{ vm_gateway | default('192.168.1.1') if vm_gateway else '192.168.1.1' }}"
    vm_netmask_input: "{{ vm_netmask | default('24') }}"
    cloud_image: "debian-12-genericcloud-amd64.qcow2"
    
  
  tasks:
    - name: Read local SSH public key (for Ansible access)
      set_fact:
        local_ssh_key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') | trim }}"
    
    - name: Get Proxmox host SSH public key
      shell: |
        ssh root@{{ proxmox_api_host }} "cat ~/.ssh/id_ed25519.pub"
      register: proxmox_ssh_key_result
    
    - name: Ensure snippets directory exists on Proxmox
      shell: |
        ssh root@{{ proxmox_api_host }} "mkdir -p /var/lib/vz/snippets"
    
    - name: Ensure local storage includes snippets content type
      shell: |
        ssh root@{{ proxmox_api_host }} "grep -q 'content.*snippets' /etc/pve/storage.cfg || sed -i 's/content iso,vztmpl,backup/content iso,vztmpl,backup,snippets/' /etc/pve/storage.cfg"
    
    - name: Create cloud-init user-data with qemu-guest-agent and SSH keys
      copy:
        content: |
          #cloud-config
          users:
            - name: root
              ssh_authorized_keys:
                - {{ local_ssh_key }}
                - {{ proxmox_ssh_key_result.stdout | trim }}
          package_update: true
          packages:
            - qemu-guest-agent
          runcmd:
            - systemctl enable qemu-guest-agent
            - systemctl start qemu-guest-agent
        dest: "/tmp/vm-{{ vm_id_input }}-userdata.yml"
    - name: Copy files to Proxmox host
      shell: |
        scp /tmp/vm-{{ vm_id_input }}-userdata.yml root@{{ proxmox_api_host }}:/var/lib/vz/snippets/vm-{{ vm_id_input }}-userdata.yml
    
    - name: Create VM
      shell: |
        ssh root@{{ proxmox_api_host }} "
        qm create {{ vm_id_input }} \
          --name {{ vm_name_input }} \
          --memory 2048 \
          --cores 2 \
          --net0 virtio,bridge=vmbr0 \
          --serial0 socket \
          --vga serial0 \
          --agent enabled=1 >/dev/null
        "
    
    - name: Import cloud image and configure cloud-init
      shell: |
        ssh root@{{ proxmox_api_host }} "
        qm importdisk {{ vm_id_input }} /var/lib/vz/template/iso/debian-12-genericcloud-amd64.qcow2 {{ vm_storage_input }} >/dev/null
        
        qm set {{ vm_id_input }} --scsihw virtio-scsi-pci >/dev/null
        qm set {{ vm_id_input }} --scsi0 {{ vm_storage_input }}:vm-{{ vm_id_input }}-disk-0 >/dev/null
        qm set {{ vm_id_input }} --boot order=scsi0 >/dev/null
        
        qm set {{ vm_id_input }} -ide2 {{ vm_storage_input }}:cloudinit >/dev/null
        
        qm set {{ vm_id_input }} \
          -ciuser root \
          -cicustom 'user=local:snippets/vm-{{ vm_id_input }}-userdata.yml' \
          -ipconfig0 {% if vm_ip_input | default('' ) | length > 0 %}ip={{ vm_ip_input }}/{{ vm_netmask_input }},gw={{ vm_gateway_input }}{% else %}ip=dhcp{% endif %} >/dev/null
        
        "
    
    - name: Start VM
      shell: |
        ssh root@{{ proxmox_api_host }} "qm start {{ vm_id_input }}"
    
    - name: Wait for VM to boot and cloud-init to complete
      pause:
        seconds: 120
    
    
    
    
    - name: Display success message
      debug:
        msg: "VM {{ vm_name_input }} deployed successfully and added to inventory!"
      when: vm_ip is defined
    - name: Update inventory with new VM
      shell: |
        python3 << 'PYTHON_EOF'
        import yaml
        
        vm_name = "{{ vm_name_input }}"
        vm_ip = "{{ vm_ip }}"
        inventory_path = "../inventory/hosts.yml"
        
        with open(inventory_path, 'r') as f:
            inventory = yaml.safe_load(f)
        
        # Ensure vms.hosts exists and is a dict
        if 'hosts' not in inventory['all']['children']['vms'] or inventory['all']['children']['vms']['hosts'] is None:
            inventory['all']['children']['vms']['hosts'] = {}
        
        # Add or update the VM
        inventory['all']['children']['vms']['hosts'][vm_name] = {
            'ansible_host': vm_ip,
            'ansible_user': 'root'
        }
        
        with open(inventory_path, 'w') as f:
            yaml.dump(inventory, f, default_flow_style=False, sort_keys=False)
        
        print(f"Added {vm_name} to inventory")
        PYTHON_EOF
      when: vm_ip is defined
    - name: Use static IP if provided
      set_fact:
        vm_ip: "{{ vm_ip_input }}"
      when: vm_ip_input | default('') | length > 0
    
    - name: Wait for VM to get IP via guest agent (DHCP mode)
      shell: |
        ssh root@{{ proxmox_api_host }} "qm guest cmd {{ vm_id_input }} network-get-interfaces" 2>/dev/null || echo "not ready"
      register: vm_network
      until: vm_network.stdout | from_json | selectattr('name', 'equalto', 'eth0') | map(attribute='ip-addresses') | map('first') | map(attribute='ip-address') | list | length > 0
      retries: 20
      delay: 15
      ignore_errors: yes
      when: vm_ip_input | default('') | length == 0
    
    - name: Extract VM IP address from guest agent (DHCP mode)
      set_fact:
        vm_ip: "{{ (vm_network.stdout | from_json | selectattr('name', 'equalto', 'eth0') | list | first)['ip-addresses'][0]['ip-address'] }}"
      when: vm_ip_input | default('') | length == 0 and vm_network is succeeded
    
    - name: Display VM IP
      debug:
        msg: "VM {{ vm_name_input }} (ID: {{ vm_id_input }}) is ready with IP: {{ vm_ip }}"
      when: vm_ip is defined
    
    - name: Verify SSH connectivity to VM
      wait_for:
        host: "{{ vm_ip }}"
        port: 22
        timeout: 120
      when: vm_ip is defined
    
    - name: Fail if VM didn't get IP
      fail:
        msg: "VM failed to get IP address"
      when: vm_ip is not defined
